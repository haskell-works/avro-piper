defaults: &defaults
  working_directory: ~/build
  steps:
    - checkout
    - run: git fetch --unshallow || true
    - run: grep '^resolver:' stack.yaml > resolver.txt

    - run:
        name: Copying scripts
        command: |
          mkdir -p ~/.local/bin
          cp ./scripts/* ~/.local/bin

    - restore_cache:
        keys:
          - dot-stack-{{ arch }}-{{ checksum "stack.yaml" }}-{{ checksum "avro-piper.cabal" }}
          - dot-stack-{{ arch }}-{{ checksum "stack.yaml" }}
          - dot-stack-{{ arch }}-{{ checksum "resolver.txt" }}
          - dot-stack-resolver-{{ arch }}-{{ checksum "resolver.txt" }}
    - run: stack setup
    - save_cache:
        key: dot-stack-resolver-{{ arch }}-{{ checksum "resolver.txt" }}
        paths:
          - ~/.stack
    - save_cache:
        key: dot-stack-{{ arch }}-{{ checksum "stack.yaml" }}
        paths:
          - ~/.stack

    - restore_cache:
        key: stack-work-{{ arch }}-{{ checksum "stack.yaml" }}
    - run: stack build --test --no-run-tests --dependencies-only
    - save_cache:
        key: dot-stack-{{ arch }}-{{ checksum "resolver.txt" }}
        paths:
          - ~/.stack

    - run: stack build --test --no-run-tests
    - save_cache:
        key: dot-stack-{{ arch }}-{{ checksum "stack.yaml" }}-{{ checksum "avro-piper.cabal" }}
        paths:
          - ~/.stack
    - save_cache:
        key: stack-work-{{ arch }}-{{ checksum "stack.yaml" }}
        paths: ~/build/.stack-work

    - run:
        name: Running unit tests
        command: stack test


version: 2.0
jobs:
  linux:
    docker:
      - image: quay.io/haskell_works/stack-build-python
    <<: *defaults

  mac-os:
    macos:
      xcode: "9.0"
    <<: *defaults

      # - deploy:
      #     command: |
      #       if [ "$CIRCLE_PROJECT_USERNAME" == "haskell-works" ]; then
      #         if [[ "$CIRCLE_BRANCH" == "master" ]]; then
      #           release
      #         fi
      #       fi

workflows:
  version: 2
  build-test-lint:
    jobs:
      - linux
      - mac-os
